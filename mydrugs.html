<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drugshub Store Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
header { background: #111; color: #fff; text-align: center; padding: 15px; }
section { padding: 20px; }
input, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 300px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
th { background: #222; color: white; }
tr:nth-child(even) { background: #eee; }
#map { height: 500px; width: 100%; margin-top: 20px; }
</style>
</head>
<body>

<header>
  <h1>Drugshub Store Dashboard</h1>
</header>

<section id="auth-section">
  <h2>Signup / Login</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="signup">Sign Up</button>
  <button id="login">Login</button>
</section>

<section id="store-section" style="display:none;">
  <h2>Products</h2>
  <button class="buy-btn" data-name="Earphones" data-price="25">Buy Earphones ($25)</button>
  <button class="buy-btn" data-name="Headphones" data-price="50">Buy Headphones ($50)</button>
</section>

<section id="dashboard-section" style="display:none;">
  <h2>Delivery Dashboard</h2>
  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Orders</th>
        <th>Last Updated</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
  <div id="map"></div>
</section>

<!-- Google Maps API -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getDatabase, ref, set, update, onValue, push, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCExki28m1NNepVQEIjmcQzR8z8O68LqIc",
  authDomain: "rinolski-notifications.firebaseapp.com",
  databaseURL: "https://rinolski-notifications-default-rtdb.firebaseio.com",
  projectId: "rinolski-notifications",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// --- Signup/Login ---
document.getElementById("signup").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await createUserWithEmailAndPassword(auth, email, password);
    alert("Signup successful!");
    await set(ref(db, 'drugshubusers/' + auth.currentUser.uid), { email });
  } catch(err){ console.error(err); alert(err.message); }
});

document.getElementById("login").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth, email, password); alert("Login successful!"); } 
  catch(err){ console.error(err); alert(err.message); }
});

// --- Auth state ---
let map, mapMarkers = [];
window.initMap = function(){
  map = new google.maps.Map(document.getElementById("map"), { center:{lat:36,lng:9}, zoom:12 });
}

onAuthStateChanged(auth, (user) => {
  if(user){
    document.getElementById("auth-section").style.display = "none";
    document.getElementById("store-section").style.display = "block";
    document.getElementById("dashboard-section").style.display = "block";

    const tbody = document.getElementById("userTable");

    onValue(ref(db,'drugshubusers/'), snapshot => {
      tbody.innerHTML = "";
      mapMarkers.forEach(m=>m.setMap(null));
      mapMarkers = [];
      const users = snapshot.val();
      if(users){
        Object.keys(users).forEach(uid=>{
          const data = users[uid];
          const ordersText = data.orders ? Object.values(data.orders).map(o=>o.name+" $"+o.price).join(", ") : "-";

          // Table
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${data.email}</td><td>${data.location?.latitude??'-'}</td><td>${data.location?.longitude??'-'}</td><td>${ordersText}</td><td>${data.lastUpdated?new Date(data.lastUpdated).toLocaleString():'-'}</td>`;
          tbody.appendChild(tr);

          // Map marker
          if(data.location){
            const marker = new google.maps.Marker({
              position: { lat:data.location.latitude, lng:data.location.longitude },
              map: map,
              title: `${data.email} - Orders: ${ordersText}`
            });
            mapMarkers.push(marker);
          }
        });
      }
    });
  }
});

// --- Buy button (multiple orders) ---
document.querySelectorAll(".buy-btn").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const user = auth.currentUser;
    if(!user) return alert("Login first!");
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const { latitude, longitude, accuracy } = pos.coords;
        const userRef = ref(db,'drugshubusers/'+user.uid);

        // Update location + lastUpdated
        await update(userRef, {
          location:{latitude, longitude, accuracy},
          lastUpdated: Date.now()
        });

        // Push new order
        const orderRef = ref(db,'drugshubusers/'+user.uid+'/orders');
        await push(orderRef, { name: btn.dataset.name, price: btn.dataset.price });
        alert(`Bought ${btn.dataset.name} and location updated!`);
      }, err=>alert("Location error: "+err.message));
    } else alert("Geolocation not supported");
  });
});
</script>
</body>
</html>
