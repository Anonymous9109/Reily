<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret place</title>
    <style>

        body { font-family: 'Inter', sans-serif; background: #0f172a; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: white; }
        .view { display: none; width: 100%; max-width: 450px; }
        .active { display: block; }
        .glass-card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); overflow: hidden; }

        /* Optimized Chat UI */
        #messages { height: 480px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; contain: content; }
        .msg { padding: 8px 14px; border-radius: 15px; max-width: 80%; line-height: 1.4; position: relative; }
        .msg.mine { background: blue; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.other { background: #334155; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .msg-meta { font-size: 0.6rem; opacity: 0.7; margin-top: 4px; text-align: right; }
        .status-tick { margin-left: 4px; font-weight: bold; }
        
        #chat-input-area { display: flex; padding: 12px; gap: 8px; background: rgba(0,0,0,0.2); }
        input { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; color: white; outline: none; }
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-view" class="view active">
        <div class="glass-card" style="padding: 40px; text-align: center;">

            <input type="text" id="username" placeholder="">
            <input type="password" id="password" placeholder="" style="margin-top: 10px;">
            <button id="loginBtn" style="width: 100%; margin-top: 20px;"></button>
        </div>
    </div>

    <div id="chat-view" class="view">
        <div class="glass-card">
            <div id="messages"></div>
            <div id="chat-input-area">
                <input type="text" id="messageInput" placeholder="Message...">
                <button id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, limitToLast, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCExki28m1NNepVQEIjmcQzR8z8O68LqIc",
            authDomain: "rinolski-notifications.firebaseapp.com",
            databaseURL: "https://rinolski-notifications-default-rtdb.firebaseio.com",
            projectId: "rinolski-notifications",
            storageBucket: "rinolski-notifications.firebasestorage.app",
            messagingSenderId: "355554579853",
            appId: "1:355554579853:web:3caa961653c0cdc0a359c4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        
        let currentUser = "";
        let otherUserLastRead = 0;

        document.getElementById('loginBtn').onclick = async () => {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            const userSnap = await getDoc(doc(db, "secret", u));

            if (userSnap.exists() && userSnap.data().password === p) {
                currentUser = u;
                document.getElementById('login-view').classList.remove('active');
                document.getElementById('chat-view').classList.add('active');
                initChat();
            }
        };

        function initChat() {
            const messagesDiv = document.getElementById("messages");
            // Optimization: Only load the last 50 messages to speed up initial load
            const msgQuery = query(ref(rtdb, "messages"), limitToLast(50));
            const myPresenceRef = ref(rtdb, `presence/${currentUser}`);

            const updatePresence = () => set(myPresenceRef, Date.now());
            updatePresence();
            window.addEventListener('focus', updatePresence);

            // Listen for presence changes and update existing checkmarks only
            onValue(ref(rtdb, "presence"), (snap) => {
                const data = snap.val() || {};
                for (let user in data) {
                    if (user !== currentUser) otherUserLastRead = data[user];
                }
                updateCheckmarks();
            });

            // Incremental rendering: Add messages one by one as they arrive
            onChildAdded(msgQuery, (snap) => {
                const msg = snap.val();
                appendMessage(msg);
                updatePresence(); 
            });

            function appendMessage(msg) {
                const isMine = msg.username === currentUser;
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const div = document.createElement("div");
                div.className = `msg ${isMine ? 'mine' : 'other'}`;
                // We add a data-time attribute to find this message later for "Seen" updates
                div.setAttribute('data-time', msg.timestamp);
                div.innerHTML = `
                    <div>${msg.text}</div>
                    <div class="msg-meta">${time} <span class="status-tick"></span></div>
                `;
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                updateCheckmarks();
            }

            function updateCheckmarks() {
                const ticks = document.querySelectorAll('.mine .status-tick');
                ticks.forEach(tick => {
                    const msgTime = tick.closest('.msg').getAttribute('data-time');
                    tick.innerText = msgTime <= otherUserLastRead ? "seen" : "sent";
                    tick.style.color = msgTime <= otherUserLastRead ? "#93c5fd" : "white";
                });
            }

            document.getElementById("sendBtn").onclick = () => {
                const input = document.getElementById("messageInput");
                if (input.value.trim()) {
                    push(ref(rtdb, "messages"), {
                        username: currentUser,
                        text: input.value,
                        timestamp: Date.now()
                    });
                    input.value = "";
                }
            };
        }
    </script>
</body>
</html>
