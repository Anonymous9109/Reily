<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Firestore Saves</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: white;
    padding: 20px;
  }
  h1 {
    margin-bottom: 20px;
  }
  .user-section {
    margin-bottom: 30px;
    border-bottom: 1px solid #444;
    padding-bottom: 20px;
  }
  .user-email {
    font-weight: bold;
    font-size: 1.2em;
    margin-bottom: 10px;
  }
  .videos-list {
    display: flex;
    gap: 15px;
    overflow-x: auto;
  }
  .video-item {
    background: #222;
    padding: 10px;
    border-radius: 8px;
    width: 140px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .video-item img {
    width: 120px;
    height: 160px;
    border-radius: 5px;
    object-fit: cover;
    cursor: pointer;
  }
  .video-name {
    margin: 8px 0 5px;
    text-align: center;
    font-size: 0.9em;
  }
  .video-link {
    font-size: 0.8em;
    color: #88f;
    word-break: break-all;
    margin-bottom: 8px;
  }
  button.remove-btn {
    background-color: #e33;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
  }
  button.remove-btn:hover {
    background-color: #c22;
  }
  #loginStatus {
    margin-bottom: 20px;
  }
</style>
</head>
<body>

<h1>Admin Panel: All Users' Saved Videos (Firestore)</h1>
<div id="loginStatus">Checking authentication...</div>
<div id="content"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, query,
    doc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCExki28m1NNepVQEIjmcQzR8z8O68LqIc",
    authDomain: "rinolski-notifications.firebaseapp.com",
    projectId: "rinolski-notifications",
    storageBucket: "rinolski-notifications.appspot.com",
    messagingSenderId: "355554579853",
    appId: "1:355554579853:web:3caa961653c0cdc0a359c4",
    measurementId: "G-WZ84970GST"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  const loginStatus = document.getElementById('loginStatus');
  const content = document.getElementById('content');

  const allowedAdmins = ["youradminemail@gmail.com"]; // Replace with your admin email(s)

  function createVideoItem(userDocId, videoDocId, videoData) {
    const div = document.createElement('div');
    div.classList.add('video-item');

    const videoName = videoData.name || videoDocId;

    div.innerHTML = `
      <a href="${videoData.link}" target="_blank" title="Open video in new tab">
        <img src="${videoData.thumbnail}" alt="${videoName}" />
      </a>
      <div class="video-name">${videoName}</div>
      <div class="video-link">${videoData.link}</div>
      <button class="remove-btn">Remove</button>
    `;

    div.querySelector('button.remove-btn').onclick = async () => {
      if(confirm(`Remove video "${videoName}" for user "${userDocId}"?`)) {
        try {
          await deleteDoc(doc(db, "watchLater", userDocId, "videos", videoDocId));
          div.remove();
        } catch (err) {
          alert("Error removing video: " + err.message);
        }
      }
    };

    return div;
  }

  async function loadData() {
    content.innerHTML = "Loading saved videos...";
    try {
      const watchLaterCol = collection(db, "watchLater");
      const usersSnapshot = await getDocs(watchLaterCol);
      content.innerHTML = "";
      if(usersSnapshot.empty) {
        content.textContent = "No saved videos found.";
        return;
      }

      for(const userDoc of usersSnapshot.docs) {
        const userDocId = userDoc.id;
        // User section container
        const userSection = document.createElement('div');
        userSection.classList.add('user-section');

        // Display user email - assuming doc id is email or you can map it properly
        userSection.innerHTML = `<div class="user-email">${userDocId}</div>`;

        // Fetch subcollection videos
        const videosCol = collection(db, "watchLater", userDocId, "videos");
        const videosSnapshot = await getDocs(videosCol);

        const videosList = document.createElement('div');
        videosList.classList.add('videos-list');

        if(videosSnapshot.empty) {
          const noVideosMsg = document.createElement('div');
          noVideosMsg.textContent = "No saved videos.";
          userSection.appendChild(noVideosMsg);
        } else {
          for(const videoDoc of videosSnapshot.docs) {
            const videoItem = createVideoItem(userDocId, videoDoc.id, videoDoc.data());
            videosList.appendChild(videoItem);
          }
          userSection.appendChild(videosList);
        }
        content.appendChild(userSection);
      }
    } catch(err) {
      content.textContent = "Error loading data: " + err.message;
    }
  }

  function login() {
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider).catch(e => alert("Login failed: " + e.message));
  }

  function logout() {
    signOut(auth).catch(e => alert("Logout failed: " + e.message));
  }

  onAuthStateChanged(auth, (user) => {
    if(user) {
      if(!allowedAdmins.includes(user.email)) {
        loginStatus.textContent = "Access denied: You are not an admin.";
        content.innerHTML = "";
        logout();
        return;
      }
      loginStatus.innerHTML = `Signed in as <b>${user.email}</b> - <button id="logoutBtn">Logout</button>`;
      document.getElementById('logoutBtn').onclick = logout;
      loadData();
    } else {
      loginStatus.innerHTML = `<button id="loginBtn">Sign in as Admin</button>`;
      content.innerHTML = "";
      document.getElementById('loginBtn').onclick = login;
    }
  });
</script>

</body>
</html>
