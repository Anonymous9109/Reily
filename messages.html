<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>secret place</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#0f0f0f;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

#login, #chat-container{
  width:95%;
  max-width:600px;
  background:#1a1a1a;
  border-radius:10px;
  box-shadow:0 0 20px #000;
  padding:15px;
}

input,button{
  padding:10px;
  margin:5px 0;
  border:none;
  border-radius:5px;
}

button{
  background:#0078D7;
  color:white;
  cursor:pointer;
}

#messages{
  height:60vh;
  overflow-y:auto;
  margin-bottom:10px;
}

.message{
  margin-bottom:12px;
}

.message-text{
  background:#0078D7;
  padding:8px 12px;
  border-radius:10px;
  max-width:70%;
}

.meta{
  font-size:11px;
  opacity:0.6;
}

#typing{
  font-size:12px;
  opacity:0.6;
  height:15px;
}
</style>
</head>
<body>

<div id="login">
  <h3>Login</h3>
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</div>

<div id="chat-container" style="display:none;">
  <div id="active"></div>
  <div id="messages"></div>
  <div id="typing"></div>
  <input type="text" id="messageInput" placeholder="Type...">
  <input type="file" id="imageInput">
  <button id="sendBtn">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, update, set, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEx...",
  authDomain: "rinolski-notifications.firebaseapp.com",
  databaseURL: "https://rinolski-notifications-default-rtdb.firebaseio.com",
  projectId: "rinolski-notifications",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const fs = getFirestore(app);

let currentUser = "";
const messagesRef = ref(db, "messages");
const presenceRef = ref(db, "presence");
const typingRef = ref(db, "typing");

const loginDiv = document.getElementById("login");
const chatDiv = document.getElementById("chat-container");
const messages = document.getElementById("messages");
const typingDiv = document.getElementById("typing");
const activeDiv = document.getElementById("active");

// LOGIN FROM FIRESTORE
document.getElementById("loginBtn").onclick = async () => {
  const u = user.value.trim();
  const p = pass.value.trim();

  const snap = await getDoc(doc(fs, "secret", u));
  if(!snap.exists()) return alert("User not found");

  if(snap.data().password !== p) return alert("Wrong password");

  currentUser = u;

  loginDiv.style.display="none";
  chatDiv.style.display="block";

  set(ref(db, "presence/"+u), {
    online:true,
    since:Date.now()
  });

  loadMessages();
};

// CLOUDINARY
async function uploadImage(file){
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", "Facemash");

  const r = await fetch("https://api.cloudinary.com/v1_1/djwuz2q85/upload", {
    method:"POST", body:fd
  });
  const d = await r.json();
  return d.secure_url;
}

// SEND MESSAGE
sendBtn.onclick = async () => {
  const text = messageInput.value.trim();
  const img = imageInput.files[0];
  if(!text && !img) return;

  let imageUrl="";
  if(img) imageUrl = await uploadImage(img);

  push(messagesRef,{
    user:currentUser,
    text,
    image:imageUrl,
    timestamp:Date.now(),
    seen:false
  });

  messageInput.value="";
  imageInput.value="";
  set(ref(db,"typing/"+currentUser), false);
};

// TYPING
messageInput.oninput = ()=>{
  set(ref(db,"typing/"+currentUser), true);
  setTimeout(()=>set(ref(db,"typing/"+currentUser), false),1500);
};

onValue(typingRef, snap=>{
  let t="";
  snap.forEach(s=>{
    if(s.key!==currentUser && s.val())
      t = s.key+" is typing...";
  });
  typingDiv.textContent=t;
});

// LOAD MESSAGES
function loadMessages(){
  onChildAdded(messagesRef, snap=>{
    const m = snap.val();

    const div = document.createElement("div");
    div.className="message";

    const txt = document.createElement("div");
    txt.className="message-text";
    txt.innerHTML = `<b>${m.user}</b><br>${m.text || ""}`;

    const meta = document.createElement("div");
    meta.className="meta";
    meta.textContent = m.user===currentUser
      ? (m.seen ? "Seen" : "Sent")
      : " ";

    div.appendChild(txt);

    if(m.image){
      const im=document.createElement("img");
      im.src=m.image;
      im.style.maxWidth="70%";
      im.style.borderRadius="10px";
      div.appendChild(im);
    }

    div.appendChild(meta);
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;

    if(m.user!==currentUser){
      update(ref(db,"messages/"+snap.key),{seen:true});
    }
  });

  // ACTIVE USERS
  onValue(presenceRef, snap=>{
    let a="Active: ";
    snap.forEach(s=>{
      if(s.val().online)
        a+= s.key+" ";
    });
    activeDiv.textContent=a;
  });
}
</script>
</body>
</html>
